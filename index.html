<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pelletwerke ‚Äì Europa Preiskarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100%}

    /* Boxen */
    .legend, .cert-box {
      position:absolute;background:#fff;padding:8px 10px;
      border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);
      font:14px/1.3 system-ui,Arial,sans-serif;
    }

    /* Zertifikate unten links */
    .cert-box{
      bottom:12px;left:12px;z-index:2000;
    }

    /* Legende Farben unten rechts */
    .legend{
      bottom:12px;right:12px;min-width:180px;z-index:2000;
    }

    /* Suche + Dropdown */
    .search-box{
      position:absolute;top:12px;right:12px;z-index:3000;
      background:#fff;padding:8px 10px;border-radius:6px;
      width:260px;box-shadow:0 2px 8px rgba(0,0,0,.15);
    }
    .search-box input{
      width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;
      margin-left:4px;box-sizing:border-box;
    }

    /* Dropdown */
    .country-dropdown{margin-top:8px;width:100%;position:relative;}
    .country-dropdown-button{
      width:100%;background:#fff;border:1px solid #ccc;border-radius:4px;
      padding:4px;cursor:pointer;text-align:left;
    }
    .country-dropdown-button:after{content:"‚ñæ";float:right;opacity:0.6;}

    .country-dropdown-menu{
      position:absolute;top:100%;left:0;width:100%;
      background:#fff;border:1px solid #ccc;border-radius:4px;
      max-height:260px;overflow-y:auto;padding:6px;
      display:none;z-index:4000;
    }

    /* Label: Text links, Checkbox rechts */
    .country-dropdown-menu label{
      display:flex;justify-content:space-between;align-items:center;
      margin-bottom:3px;cursor:pointer;
    }

  </style>
</head>
<body>

<div id="map"></div>

<!-- Suchfeld + Land-Dropdown -->
<div class="search-box">
  üîç <input type="text" id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶">

  <b style="display:block;margin-top:6px;">Land / L√§nder filtern</b>

  <div class="country-dropdown" id="countryDropdown">
    <div class="country-dropdown-button" id="countryDropdownBtn">Alle L√§nder</div>

    <div class="country-dropdown-menu" id="countryDropdownMenu">

      <!-- alphabetisch + Checkbox rechts -->
      <label>Alle        <input type="checkbox" class="countryChk" value="all" checked></label>
      <label>Belgien     <input type="checkbox" class="countryChk" value="be"></label>
      <label>Deutschland <input type="checkbox" class="countryChk" value="de"></label>
      <label>Frankreich  <input type="checkbox" class="countryChk" value="fr"></label>
      <label>√ñsterreich  <input type="checkbox" class="countryChk" value="at"></label>
      <label>Polen       <input type="checkbox" class="countryChk" value="pl"></label>
      <label>Schweiz     <input type="checkbox" class="countryChk" value="ch"></label>
      <label>Slowakei    <input type="checkbox" class="countryChk" value="sk"></label>
      <label>Tschechien  <input type="checkbox" class="countryChk" value="cz"></label>

    </div>
  </div>
</div>

<!-- Zertifikate -->
<div class="cert-box">
  <b>Zertifikate & Sackware</b><br>
  <label><input type="checkbox" id="chkEnPlus" checked> EnPlus</label><br>
  <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
  <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
  <label><input type="checkbox" id="chkCPP" checked> CPP</label><br>
  <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>
  <hr>
  <label><input type="checkbox" id="chkSackFireflies"> FireFlies</label><br>
  <label><input type="checkbox" id="chkSack15kg"> 15 kg</label>
</div>

<!-- Farben -->
<div class="legend">
  <b>Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>
  <label><input type="checkbox" id="chkKunden" checked> üî∑ Kunden</label><br>
  <label><input type="checkbox" id="chkSackKunden" checked> üü£ Sackwaren-Kunden</label>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

const map = L.map("map").setView([51,11],5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

function colorForPrice(p){
  if(!p) return "#9e9e9e";
  if(p <= 260) return "green";
  if(p < 285) return "orange";
  return "red";
}

let werke = [];
let kunden = [];
let alleMarker = [];
let avgPriceByCountry = {};  // ‚¨ÖÔ∏è NEU: Durchschnitt pro Land

const geoCache = JSON.parse(localStorage.getItem("geoCachePellets_EU") || "{}");

async function geocode(q){
  if(geoCache[q]) return geoCache[q];

  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}&limit=1`);
  const j = await r.json();
  if(!j.length) return null;

  const c = {
    lat:+j[0].lat,
    lon:+j[0].lon,
    country_code:j[0].address.country_code.toLowerCase()
  };
  geoCache[q] = c;
  localStorage.setItem("geoCachePellets_EU", JSON.stringify(geoCache));
  return c;
}

const iconKunde = L.divIcon({
  html:`<svg width="22" height="22"><polygon points="11,2 21,20 1,20" fill="blue"/></svg>`,
  iconAnchor:[11,20]
});
const iconSackKunde = L.divIcon({
  html:`<svg width="22" height="22"><polygon points="11,2 21,20 1,20" fill="purple"/></svg>`,
  iconAnchor:[11,20]
});

const sheetFirmen = "https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/export?format=csv";
const sheetKunden = "https://docs.google.com/spreadsheets/d/1DaiLyZbhJkdSQ1PHbJQmguIrDnGrrhiAVgJC4PJO8vA/export?format=csv&gid=0";

/* --- Daten laden --- */
async function ladeDaten(){
  // Firmen
  await new Promise(res=>{
    Papa.parse(sheetFirmen,{
      download:true,header:true,
      complete:r=>{
        werke = r.data
          .filter(x => x.Firma && x.Ort)
          .map(x => ({
            firma:x.Firma,
            ort:x.Ort,
            preis:parseFloat((x.Preis||"0").replace(",",".")),
          }));
        res();
      }
    });
  });

  // Kunden
  await new Promise(res=>{
    Papa.parse(sheetKunden,{
      download:true,header:true,
      complete:r=>{
        kunden = r.data
          .filter(x=>x.Name && x.Ort)
          .map(x=>({
            name:x.Name,
            ort:x.Ort,
            sackware:(x.Sackware||"").toLowerCase(),
            lose:(x.Lose||"").toLowerCase()
          }));
        res();
      }
    });
  });

  berechneDurchschnittspreiseProLand();  // ‚¨ÖÔ∏è Durchschnitt berechnen
}

/* --- Durchschnitt pro Land --- */
function berechneDurchschnittspreiseProLand(){
  const groups = {};

  werke.forEach(w=>{
    const cc = w.country_code;
    if(!groups[cc]) groups[cc] = [];
    groups[cc].push(w.preis);
  });

  avgPriceByCountry = {};

  for(const land in groups){
    const arr = groups[land];
    avgPriceByCountry[land] = (arr.reduce((a,b)=>a+b,0) / arr.length).toFixed(2);
  }
}

/* --- Tooltip erzeugen (mit Landesdurchschnitt) --- */
function tooltipHtmlFromMarker(w){
  const avg = avgPriceByCountry[w.country_code] || "‚Äì";

  return `
    <b>${w.firma}</b><br>
    ${w.ort}<br>
    <b>Preis:</b> ${w.preis.toFixed(2)} ‚Ç¨<br>
    <b>Landesdurchschnitt:</b> ${avg} ‚Ç¨
  `;
}

/* --- Karte aufbauen --- */
async function buildMap(){
  const bounds = L.latLngBounds();

  // Werke eintragen
  for(const w of werke){
    const g = await geocode(w.ort);
    if(!g) continue;
    w.country_code = g.country_code;

    const c = colorForPrice(w.preis);

    const m = L.circleMarker([g.lat,g.lon],{
      radius:8,color:c,fillColor:c,fillOpacity:0.85
    }).bindTooltip( tooltipHtmlFromMarker(w) ,{sticky:true});

    alleMarker.push({type:"firma",marker:m,country_code:g.country_code});
    bounds.extend([g.lat,g.lon]);
  }

  // Kunden
  for(const k of kunden){
    const g = await geocode(k.ort);
    if(!g) continue;

    const icon = (k.sackware==="ja" && k.lose!=="ja") ? iconSackKunde : iconKunde;

    const m = L.marker([g.lat,g.lon],{icon})
      .bindTooltip(`<b>${k.name}</b><br>${k.ort}`);

    alleMarker.push({type:"kunde",marker:m,country_code:g.country_code});
    bounds.extend([g.lat,g.lon]);
  }

  if(bounds.isValid()) map.fitBounds(bounds.pad(0.15));

  updateLayers();
}

/* --- L√§nderfilter --- */
function getSelectedCountries(){
  const checked = [...document.querySelectorAll(".countryChk:checked")].map(x=>x.value);
  return checked.includes("all") ? ["all"] : checked;
}

function updateCountryButtonLabel(){
  const sel = getSelectedCountries();
  const btn = document.getElementById("countryDropdownBtn");

  if(sel[0]==="all"){
    btn.textContent = "Alle L√§nder";
    return;
  }

  btn.textContent = sel.map(c=>c.toUpperCase()).join(", ");
}

/* --- Layer aktualisieren --- */
function updateLayers(){
  alleMarker.forEach(m=>map.removeLayer(m.marker));

  const sel = getSelectedCountries();
  const noFilter = sel.includes("all");

  for(const m of alleMarker){
    if(noFilter || sel.includes(m.country_code)){
      map.addLayer(m.marker);
    }
  }
}

/* --- Dropdown √∂ffnen/schlie√üen --- */
document.getElementById("countryDropdownBtn").addEventListener("click",()=>{
  const menu = document.getElementById("countryDropdownMenu");
  menu.style.display = (menu.style.display==="block") ? "none" : "block";
});

document.addEventListener("click",e=>{
  if(!document.getElementById("countryDropdown").contains(e.target)){
    document.getElementById("countryDropdownMenu").style.display="none";
  }
});

document.addEventListener("change",e=>{
  if(e.target.classList.contains("countryChk")){
    if(e.target.value==="all"){
      if(e.target.checked){
        document.querySelectorAll(".countryChk").forEach(x=>{
          if(x.value!=="all") x.checked=false;
        });
      }
    } else {
      document.querySelector('.countryChk[value="all"]').checked=false;
    }
    updateCountryButtonLabel();
  }
  updateLayers();
});

/* --- Suche --- */
document.getElementById("searchInput").addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    const q = e.target.value.toLowerCase();

    const hit = alleMarker.find(m =>
      m.marker.getTooltip()?.getContent().toLowerCase().includes(q)
    );
    if(hit){
      map.setView(hit.marker.getLatLng(),10);
      hit.marker.openTooltip();
    } else {
      alert("Kein Treffer gefunden.");
    }
  }
});

/* --- Start --- */
(async()=>{
  await ladeDaten();
  await buildMap();
})();
</script>

</body>
</html>
