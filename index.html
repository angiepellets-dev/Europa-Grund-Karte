<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pelletwerke ‚Äì Europa Preiskarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100%}

    .legend, .cert-box {
      position:absolute;z-index:1000;background:#fff;padding:8px 10px;
      border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);
      font:14px/1.3 system-ui,Arial,sans-serif;
    }
    .legend{bottom:12px;right:12px}
    .cert-box{bottom:12px;left:12px;}

    .cert-box input[type="checkbox"],
    .legend input[type="checkbox"]{
      width:14px;height:14px;margin-right:5px;vertical-align:middle;
    }

    .search-box{
      position:absolute;top:12px;right:12px;z-index:1000;
      background:#fff;padding:8px 10px;border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      font:14px system-ui,Arial,sans-serif
    }
    .search-box input{
      width:220px;padding:6px 8px;border:1px solid #ccc;border-radius:4px;outline:none;
    }
    .cert-box hr{border:none;height:1px;background:#eee;margin:6px 0}
  </style>
</head>
<body>
<div id="map"></div>

<!-- Suche -->
<div class="search-box">
  üîç <input type="text" id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶" />
</div>

<!-- Zertifikate + Sackware -->
<div class="cert-box">
  <b>Zertifikate & Sackware</b><br>
  <label><input type="checkbox" id="chkEnPlus" checked> EnPlus</label><br>
  <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
  <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
  <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>
  <hr>
  <b>Sackware</b><br>
  <label><input type="checkbox" id="chkSackFireflies"> FireFlies</label><br>
  <label><input type="checkbox" id="chkSack15kg"> 15 kg</label>
</div>

<!-- Farben -->
<div class="legend">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>
  <label><input type="checkbox" id="chkKunden" checked> üî∑ Kunden</label>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([51, 11], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  minZoom: 4, maxZoom: 10, attribution: "&copy; OpenStreetMap"
}).addTo(map);

function colorForPrice(p, keinPreis) {
  if (keinPreis) return "#9e9e9e";
  if (!p || p <= 0 || isNaN(p)) return "#9e9e9e";
  if (p <= 260) return "green";
  if (p < 285) return "orange";
  return "red";
}

const geoCache = JSON.parse(localStorage.getItem("geoCachePellets_EU") || "{}");
async function geocode(q) {
  if (geoCache[q]) return geoCache[q];
  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&accept-language=de`);
  const d = await r.json();
  if (d.length) {
    geoCache[q] = { lat: +d[0].lat, lon: +d[0].lon };
    localStorage.setItem("geoCachePellets_EU", JSON.stringify(geoCache));
    return geoCache[q];
  }
  console.warn("Kein Geocode-Treffer:", q);
  return null;
}

const blauesDreieck = L.divIcon({
  className: "custom-triangle",
  html: `<svg width="24" height="24" viewBox="0 0 24 24">
           <polygon points="12,2 22,22 2,22" fill="blue" stroke="black" stroke-width="1"/>
         </svg>`,
  iconAnchor: [12,22],
  popupAnchor: [0,-20]
});

// Google Sheets
const sheetUrlFirmen = "https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/export?format=csv";
const sheetUrlKunden = "https://docs.google.com/spreadsheets/d/1DaiLyZbhJkdSQ1PHbJQmguIrDnGrrhiAVgJC4PJO8vA/export?format=csv&gid=0";

let werke = [], kunden = [], alleMarker = [], selectedPoints = [], routeLine = null;

// --- Firmen: robustes Parsing (Header-Name bevorzugt, sonst Fallback nach Index) ---
function parseFirmenWithHeader(rows){
  const lc = (s)=>s.toLowerCase();

  const nameKey = Object.keys(rows[0]).find(k=>["firma","name","werk"].includes(lc(k))) || Object.keys(rows[0])[0];
  const ortKey  = Object.keys(rows[0]).find(k=>["ort","stadt","location","standort","adresse"].includes(lc(k))) || Object.keys(rows[0])[1];

  // Werkspreis (Spalte C typ.)
  const preisKey = Object.keys(rows[0]).find(k=>{
    const x = lc(k);
    return ["preis","price","‚Ç¨/t","euro","euro_t","werkpreis"].includes(x) || /preis.*c/.test(x);
  });

  // Sackware-Preis (Spalte E typ.)
  const sackPreisKey = Object.keys(rows[0]).find(k=>{
    const x = lc(k);
    return ["preis_sack","preis sack","sackpreis","bag_price","sackwarepreis","sackware preis","preis_e"].includes(x) || /preis.*e/.test(x);
  });

  const zertKey = Object.keys(rows[0]).find(k=>["zertifikate","zertifikat","zert","cert"].includes(lc(k)));
  const sackKey = Object.keys(rows[0]).find(k=>["sackware","sack","bag","bagged"].includes(lc(k)));

  return rows
    .filter(x => (x?.[nameKey]||"").trim() && (x?.[ortKey]||"").trim())
    .map(x => ({
      firma: (x[nameKey]||"").trim(),
      ort: (x[ortKey]||"").trim(),
      preis: parseFloat(String(x?.[preisKey] ?? "0").replace(",", ".")),
      preisSack: parseFloat(String(x?.[sackPreisKey] ?? "0").replace(",", ".")),
      zert: (x?.[zertKey]||"").trim(),
      sack: (x?.[sackKey]||"").trim()
    }));
}

async function ladeDaten() {
  // Firmen (erst header:true, Fallback header:false+Index)
  const firmenPromise = new Promise((resolve) => {
    Papa.parse(sheetUrlFirmen, {
      download: true, header: true,
      complete: (r) => {
        try{
          let daten = [];
          if (r.data && r.data.length && Object.keys(r.data[0]).length > 1) {
            daten = parseFirmenWithHeader(r.data);
          }
          // Fallback, falls Header nicht passt
          if (!daten.length) {
            Papa.parse(sheetUrlFirmen, {
              download: true, header: false,
              complete: (r2) => {
                const rows = r2.data.filter(row => row.length >= 8 && row[0] && row[1]);
                const daten2 = rows.map(row => ({
                  firma: (row[0]||"").trim(),      // A
                  ort:   (row[1]||"").trim(),      // B
                  preis: parseFloat(String(row[2]||"0").replace(",", ".")), // C
                  preisSack: parseFloat(String(row[4]||"0").replace(",", ".")), // E
                  zert:  (row[6]||"").trim(),      // G
                  sack:  (row[7]||"").trim()       // H (sackware)
                }));
                resolve(normalizePreise(daten2));
              }
            });
            return;
          }
          resolve(normalizePreise(daten));
        }catch(e){
          console.error("Header-Parsing Fehler:", e);
          resolve([]);
        }
      }
    });
  });

  // Kunden (wie gehabt)
  const kundenPromise = new Promise((resolve)=>{
    Papa.parse(sheetUrlKunden, {
      download:true, header:true,
      complete:(r)=>{
        const headers = Object.keys(r.data[0]||{});
        const nameKey = headers.find(h=>h.toLowerCase().includes("name"))||"name";
        const ortKey = headers.find(h=>["ort","adresse","standort","anschrift","stadt","location"].includes(h.toLowerCase()))||"ort";
        resolve(r.data.map(x=>({name:(x[nameKey]||"").trim(), ort:(x[ortKey]||"").trim()})).filter(x=>x.name && x.ort));
      }
    });
  });

  const [firmen, kundenDaten] = await Promise.all([firmenPromise, kundenPromise]);
  werke = firmen; kunden = kundenDaten;
}

function normalizePreise(daten){
  // getrennte Mittelwerte f√ºr Werkspreis (C) und Sackpreis (E)
  const g√ºltigeWerk = daten.filter(w => !isNaN(w.preis) && w.preis > 0);
  const g√ºltigeSack = daten.filter(w => !isNaN(w.preisSack) && w.preisSack > 0);
  const avgWerk = g√ºltigeWerk.length ? (g√ºltigeWerk.reduce((a,b)=>a+b.preis,0)/g√ºltigeWerk.length) : 0;
  const avgSack = g√ºltigeSack.length ? (g√ºltigeSack.reduce((a,b)=>a+b.preisSack,0)/g√ºltigeSack.length) : 0;

  return daten.map(w=>{
    if(isNaN(w.preis)||w.preis<=0){w.preis=avgWerk;w.keinPreisWerk=true;}else w.keinPreisWerk=false;
    if(isNaN(w.preisSack)||w.preisSack<=0){w.preisSack=avgSack;w.keinPreisSack=true;}else w.keinPreisSack=false;

    // Farben f√ºr beide Preisarten vorab berechnen
    w.farbeWerk = colorForPrice(w.preis, w.keinPreisWerk);
    w.farbeSack = colorForPrice(w.preisSack, w.keinPreisSack);
    return w;
  });
}

function sackFilterAktiv(){
  const wantFireflies = document.getElementById("chkSackFireflies").checked;
  const want15kg      = document.getElementById("chkSack15kg").checked;
  return (wantFireflies || want15kg);
}

function preisAnzeigeUndFarbeFor(w){
  const useSack = sackFilterAktiv();
  const preis = useSack ? w.preisSack : w.preis;
  const keinPreis = useSack ? w.keinPreisSack : w.keinPreisWerk;
  const farbe = useSack ? w.farbeSack : w.farbeWerk;
  return {preis, keinPreis, farbe, useSack};
}

async function buildMap(){
  alleMarker = [];
  const bounds=L.latLngBounds();

  for(const w of werke){
    const c=geoCache[w.ort]||await geocode(w.ort);
    if(!c)continue;

    const zertInfo = w.zert ? `<br><b>Zertifikat:</b> ${w.zert}` : "";
    const sackInfo = w.sack ? `<br><b>Sackware:</b> ${w.sack}` : "";

    // initiale Preis-/Farbwahl (√§ndert sich dynamisch in updateLayers)
    const {preis, farbe} = preisAnzeigeUndFarbeFor(w);

    const m=L.circleMarker([c.lat,c.lon],{radius:8,color:farbe,fillColor:farbe,fillOpacity:0.85})
      .bindTooltip(() => {
        const {preis: pNow} = preisAnzeigeUndFarbeFor(w);
        return `<b>${w.firma}</b><br>${w.ort}<br>${(pNow||0).toFixed(2)} ‚Ç¨${zertInfo}${sackInfo}`;
      },{sticky:true})
      .on("click",()=>handleMarkerClick(w.firma,c));

    alleMarker.push({
      type:"firma",
      marker:m,
      firma:w.firma,
      ort:w.ort,
      preis:w.preis,
      preisSack:w.preisSack,
      keinPreisWerk:w.keinPreisWerk,
      keinPreisSack:w.keinPreisSack,
      farbeWerk:w.farbeWerk,
      farbeSack:w.farbeSack,
      zert:(w.zert||"").toLowerCase(),
      sack:(w.sack||"")
    });
    bounds.extend([c.lat,c.lon]);
  }

  for(const k of kunden){
    const c=geoCache[k.ort]||await geocode(k.ort);
    if(!c)continue;
    const m=L.marker([c.lat,c.lon],{icon:blauesDreieck})
      .bindTooltip(`<b>${k.name}</b><br>${k.ort}`,{sticky:true})
      .on("click",()=>handleMarkerClick(k.name,c));
    alleMarker.push({type:"kunde",marker:m});
    bounds.extend([c.lat,c.lon]);
  }

  if(bounds.isValid())map.fitBounds(bounds.pad(0.15));
  updateLayers(); // initialer Render mit dynamischer Farb-/Tooltip-Logik
}

function updateLayers(){
  // Immer alle runternehmen
  alleMarker.forEach(m=>{ if(map.hasLayer(m.marker)) map.removeLayer(m.marker); });

  // IDs IMMER direkt abfragen
  const en         = document.getElementById("chkEnPlus").checked;
  const din        = document.getElementById("chkDINplus").checked;
  const sure       = document.getElementById("chkSURE").checked;
  const ohne       = document.getElementById("chkOhneZert").checked;

  const gruen      = document.getElementById("chkGruen").checked;
  const orange     = document.getElementById("chkOrange").checked;
  const rot        = document.getElementById("chkRot").checked;
  const grau       = document.getElementById("chkGrau").checked;
  const kundenFlag = document.getElementById("chkKunden").checked;

  const wantFireflies = document.getElementById("chkSackFireflies").checked;
  const want15kg      = document.getElementById("chkSack15kg").checked;
  const useSack       = (wantFireflies || want15kg);

  for(const m of alleMarker){
    if(m.type === "kunde"){
      if(kundenFlag) map.addLayer(m.marker);
      continue;
    }

    // Sackware-Filter (Spalte H: "sackware") ‚Üí wenn einer gesetzt ist, m√ºssen passende Eintr√§ge vorhanden sein
    if (useSack) {
      const sNorm = (m.sack||"").toLowerCase().replace(/\s+/g,' ').trim();
      const hasFireflies = sNorm.includes("fireflies");
      const has15kg = sNorm.includes("15 kg") || sNorm.includes("15kg");
      if (wantFireflies && !hasFireflies) continue;
      if (want15kg && !has15kg) continue;
    }

    // Zertifikate
    const z = m.zert || "";
    let zertOK = false;
    if(z.includes("enplus") && en) zertOK = true;
    if(z.includes("dinplus") && din) zertOK = true;
    if(z.includes("sure") && sure) zertOK = true;
    if(!z && ohne) zertOK = true;
    if(!zertOK) continue;

    // Preisfarbe nach aktueller Preisquelle (Werk vs. Sackware)
    const aktiveFarbe = useSack ? m.farbeSack : m.farbeWerk;

    // Legendenfilter
    const isGruen  = aktiveFarbe === "green";
    const isOrange = aktiveFarbe === "orange";
    const isRot    = aktiveFarbe === "red";
    const isGrau   = aktiveFarbe === "#9e9e9e";

    let sichtbar = false;
    if(isGruen && gruen) sichtbar = true;
    if(isOrange && orange) sichtbar = true;
    if(isRot && rot) sichtbar = true;
    if(isGrau && grau) sichtbar = true;
    if(!sichtbar) continue;

    // Marker-Farbe live aktualisieren
    m.marker.setStyle({color:aktiveFarbe, fillColor:aktiveFarbe});

    // Tooltip wird bei √ñffnung dynamisch generiert (siehe buildMap bindTooltip-Callback)
    map.addLayer(m.marker);
  }
}

function handleMarkerClick(label,coord){
  selectedPoints.push({label,coord});
  if(selectedPoints.length===2){
    const [a,b]=selectedPoints;
    showRoute(a,b);
    selectedPoints=[];
  }
}

async function showRoute(a,b){
  const url = `https://router.project-osrm.org/route/v1/driving/${a.coord.lon},${a.coord.lat};${b.coord.lon},${b.coord.lat}?overview=full&geometries=geojson`;
  const res = await fetch(url);
  const data = await res.json();
  if(data.routes && data.routes.length){
    const route = data.routes[0];
    const dist = (route.distance/1000).toFixed(1);
    const durationMin = route.duration/60;
    const hours = Math.floor(durationMin/60);
    const minutes = Math.round(durationMin%60);
    const durationStr = hours>0?`${hours}h ${minutes}min`:`${minutes}min`;
    const coords = route.geometry.coordinates.map(c=>[c[1],c[0]]);

    // Aktuellen Preis (Werk vs. Sackware) f√ºr die gew√§hlte Firma verwenden
    const useSack = sackFilterAktiv();
    const firmeneintrag = werke.find(w => w.firma === a.label || w.firma === b.label);
    const firmenPreis = firmeneintrag
      ? (useSack ? firmeneintrag.preisSack : firmeneintrag.preis)
      : 0;

    const preisProKm = parseFloat(dist) < 250 ? 2.15 : 1.85;
    const teilstrecke = parseFloat(dist) / 24;
    const berechnung = teilstrecke * preisProKm;
    const gesamt = ((berechnung + (firmenPreis||0)) * 1.05).toFixed(2);

    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords,{color:'blue',weight:5,opacity:0.8}).addTo(map);
    const mid = coords[Math.floor(coords.length/2)];
    L.popup().setLatLng(mid).setContent(`
      <b>Route:</b> ${a.label} ‚Üî ${b.label}<br>
      <b>Entfernung:</b> ${dist} km<br>
      <b>Dauer:</b> ${durationStr}<br>
      <b>Preis pro km:</b> ${preisProKm.toFixed(2)} ‚Ç¨<br>
      <b>${useSack ? "Sackware-Preis" : "Werkspreis"}:</b> ${(firmenPreis||0).toFixed(2)} ‚Ç¨<br>
      <b>Gesamtkosten:</b> <span style="color:green;font-size:1.1em">${gesamt} ‚Ç¨</span>
    `).openOn(map);
    map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
  } else alert("Keine Route gefunden!");
}

// Alle Checkboxen triggern das Redraw
document.addEventListener("change", e => {
  if(e.target && e.target.matches('input[type="checkbox"]')) updateLayers();
});

// Suche
document.getElementById("searchInput").addEventListener("keydown", e => {
  if(e.key === "Enter"){
    const query = e.target.value.toLowerCase().trim();
    if(!query) return;
    const treffer = alleMarker.find(m =>
      m.marker.getTooltip && (typeof m.marker.getTooltip().getContent === "function"
        ? String(m.marker.getTooltip().getContent()).toLowerCase().includes(query)
        : String(m.marker.getTooltip().getContent).toLowerCase().includes(query))
    );
    if(treffer){
      const latlng = treffer.marker.getLatLng();
      map.setView(latlng,9);
      treffer.marker.openTooltip();
    } else alert("Kein Treffer gefunden.");
  }
});

(async ()=>{
  await ladeDaten();
  await buildMap();
})();
</script>
</body>
</html>
