<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pelletwerke ‚Äì Europa Preiskarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100%}

    /* Boxen-Design */
    .legend, .cert-box {
      position:absolute;background:#fff;padding:8px 10px;
      border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);
      font:14px/1.3 system-ui,Arial,sans-serif;
      z-index:2000;
    }

    /* Zertifikate unten links */
    .cert-box{
      bottom:12px;
      left:12px;
      z-index:3000;
    }

    /* Legende unten rechts */
    .legend{
      bottom:12px;
      right:12px;
      min-width:180px;
      z-index:3000;
    }

    /* Suchbox */
    .search-box{
      position:absolute;top:12px;right:12px;z-index:3500;
      background:#fff;padding:8px 10px;border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      width:260px;
    }
    .search-box input{
      width:100%;padding:6px 8px;border:1px solid #ccc;border-radius:4px;
      box-sizing:border-box;margin-left:4px;
    }

    /* Dropdown */
    .country-dropdown { margin-top:8px;width:100%; }
    .country-dropdown-button {
      width:100%;background:#fff;border:1px solid #ccc;border-radius:4px;
      padding:4px 6px;cursor:pointer;text-align:left;
    }
    .country-dropdown-button:after {content:"‚ñæ";float:right;opacity:.6;}

    .country-dropdown-menu {
      position:absolute;top:100%;left:0;width:100%;
      background:#fff;border:1px solid #ccc;border-radius:4px;
      box-shadow:0 2px 8px rgba(0,0,0,.12);display:none;
      max-height:260px;overflow-y:auto;padding:6px 8px;z-index:4000;
    }

    /* Label: Text links, Checkbox rechts */
    .country-dropdown-menu label {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-bottom:3px;
      cursor:pointer;
    }
  </style>
</head>
<body>
<div id="map"></div>

<!-- Suche + Dropdown -->
<div class="search-box">
  üîç <input type="text" id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶">

  <b style="display:block;margin-top:6px;">Land / L√§nder filtern</b>

  <div class="country-dropdown" id="countryDropdown">
    <div class="country-dropdown-button" id="countryDropdownBtn">Alle L√§nder</div>

    <div class="country-dropdown-menu" id="countryDropdownMenu">

      <!-- alphabetisch sortiert + Checkbox rechts -->
      <label>Alle       <input type="checkbox" class="countryChk" value="all" checked></label>
      <label>Belgien    <input type="checkbox" class="countryChk" value="be"></label>
      <label>Deutschland<input type="checkbox" class="countryChk" value="de"></label>
      <label>Frankreich <input type="checkbox" class="countryChk" value="fr"></label>
      <label>√ñsterreich <input type="checkbox" class="countryChk" value="at"></label>
      <label>Polen      <input type="checkbox" class="countryChk" value="pl"></label>
      <label>Schweiz    <input type="checkbox" class="countryChk" value="ch"></label>
      <label>Slowakei   <input type="checkbox" class="countryChk" value="sk"></label>
      <label>Tschechien <input type="checkbox" class="countryChk" value="cz"></label>

    </div>
  </div>
</div>

<!-- Zertifikate -->
<div class="cert-box">
  <b>Zertifikate & Sackware</b><br>
  <label><input type="checkbox" id="chkEnPlus" checked> EnPlus</label><br>
  <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
  <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
  <label><input type="checkbox" id="chkCPP" checked> CPP</label><br>
  <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>
  <hr>
  <b>Sackware</b><br>
  <label><input type="checkbox" id="chkSackFireflies"> FireFlies</label><br>
  <label><input type="checkbox" id="chkSack15kg"> 15 kg</label>
</div>

<!-- Legende -->
<div class="legend">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>
  <label><input type="checkbox" id="chkKunden" checked> üî∑ Kunden</label><br>
  <label><input type="checkbox" id="chkSackKunden" checked> üü£ Sackwaren-Kunden</label>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

/* ==============================
   KARTE INITIALISIEREN
   ============================== */

const map = L.map("map").setView([51, 11], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  minZoom: 4, maxZoom: 10
}).addTo(map);

/* ========= Hilfsfunktionen ========= */

function colorForPrice(p, keinPreis) {
  if (keinPreis) return "#9e9e9e";
  if (!p || p <= 0) return "#9e9e9e";
  if (p <= 260) return "green";
  if (p < 285) return "orange";
  return "red";
}

const geoCache = JSON.parse(localStorage.getItem("geoCachePellets_EU") || "{}");

async function geocode(q){
  if(geoCache[q]) return geoCache[q];

  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}&limit=1`);
  const d = await r.json();
  if(!d.length) return null;

  const item = d[0];
  geoCache[q] = {
    lat:+item.lat,
    lon:+item.lon,
    country_code:item.address.country_code.toLowerCase()
  };
  localStorage.setItem("geoCachePellets_EU", JSON.stringify(geoCache));
  return geoCache[q];
}

/* Icons */
const blauesDreieck = L.divIcon({
  html:`<svg width="24" height="24"><polygon points="12,2 22,22 2,22" fill="blue" stroke="black"/></svg>`,
  iconAnchor:[12,22]
});

const lilaDreieck = L.divIcon({
  html:`<svg width="24" height="24"><polygon points="12,2 22,22 2,22" fill="purple" stroke="black"/></svg>`,
  iconAnchor:[12,22]
});

/* Datenquellen */
const sheetUrlFirmen="https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/export?format=csv";
const sheetUrlKunden="https://docs.google.com/spreadsheets/d/1DaiLyZbhJkdSQ1PHbJQmguIrDnGrrhiAVgJC4PJO8vA/export?format=csv&gid=0";

let werke=[], kunden=[], alleMarker=[];

/* =============== Daten laden ================= */

function parseFirmen(rows){
  return rows.map(x=>({
    firma:x["Firma"]||x["Name"]||"",
    ort:x["Ort"]||x["Adresse"]||"",
    preis:parseFloat((x["Preis"]||"0").replace(",", ".")),
    preisSack:parseFloat((x["Preis Sack"]||"0").replace(",", ".")),
    zert:(x["Zertifikat"]||"").toLowerCase(),
    sack:(x["Sackware"]||"")
  })).filter(x=>x.firma&&x.ort);
}

async function ladeDaten(){

  // Firmen
  const f = await new Promise(res=>{
    Papa.parse(sheetUrlFirmen,{download:true,header:true,complete:r=>res(parseFirmen(r.data))});
  });

  f.forEach(w=>{
    if(!w.preis){w.preis=270;w.keinPreisWerk=true;}
    if(!w.preisSack){w.preisSack=270;w.keinPreisSack=true;}
    w.farbeWerk = colorForPrice(w.preis,w.keinPreisWerk);
    w.farbeSack = colorForPrice(w.preisSack,w.keinPreisSack);
  });

  werke=f;

  // Kunden
  const k = await new Promise(res=>{
    Papa.parse(sheetUrlKunden,{download:true,header:true,complete:r=>res(r.data)});
  });

  kunden = k.map(x=>({
    name:x["Name"]||"",
    ort:x["Ort"]||"",
    lose:(x["Lose"]||"").toLowerCase(),
    sackware:(x["Sackware"]||"").toLowerCase()
  })).filter(x=>x.name&&x.ort);
}

/* ==================== Karte aufbauen ==================== */

async function buildMap(){
  const bounds = L.latLngBounds();

  // Firmen
  for(const w of werke){
    const c=await geocode(w.ort); if(!c)continue;

    const col=w.farbeWerk;

    const m=L.circleMarker([c.lat,c.lon],{radius:8,color:col,fillColor:col,fillOpacity:0.85})
      .bindTooltip(`<b>${w.firma}</b><br>${w.ort}<br>${w.preis} ‚Ç¨`);

    alleMarker.push({type:"firma",marker:m,country_code:c.country_code});
    bounds.extend([c.lat,c.lon]);
  }

  // Kunden
  for(const k of kunden){
    const c=await geocode(k.ort); if(!c)continue;
    const icon = (k.sackware==="ja" && k.lose!=="ja") ? lilaDreieck : blauesDreieck;

    const m=L.marker([c.lat,c.lon],{icon})
      .bindTooltip(`<b>${k.name}</b><br>${k.ort}`);

    alleMarker.push({type:"kunde",marker:m,country_code:c.country_code});
    bounds.extend([c.lat,c.lon]);
  }

  if(bounds.isValid()) map.fitBounds(bounds.pad(0.15));
  updateLayers();
}

/* ==================== Filterlogik ==================== */

function getSelectedCountries(){
  const sel=[...document.querySelectorAll(".countryChk:checked")].map(x=>x.value);
  return sel.includes("all")?["all"]:sel;
}

function updateCountryButtonLabel(){
  const s=getSelectedCountries();
  const btn=document.getElementById("countryDropdownBtn");
  const short={de:"DE",at:"AT",pl:"PL",cz:"CZ",fr:"FR",ch:"CH",be:"BE",sk:"SK"};

  if(s[0]==="all"){btn.textContent="Alle L√§nder";return;}
  btn.textContent = s.map(x=>short[x]||x).join(", ");
}

function updateLayers(){
  alleMarker.forEach(m=>map.removeLayer(m.marker));

  const sel = getSelectedCountries();
  const noFilter = sel.includes("all");

  const kundenF = document.getElementById("chkKunden").checked;
  const sackF   = document.getElementById("chkSackKunden").checked;

  for(const m of alleMarker){

    // L√§nderfilter
    if(!noFilter && !sel.includes(m.country_code)) continue;

    // Kundenfilter
    if(m.type==="kunde"){
      if(kundenF) map.addLayer(m.marker);
      continue;
    }

    // Firmen hinzuf√ºgen
    map.addLayer(m.marker);
  }
}

/* ==================== Events ==================== */

document.addEventListener("change",e=>{
  if(e.target.classList.contains("countryChk")){
    if(e.target.value==="all" && e.target.checked){
      document.querySelectorAll(".countryChk").forEach(x=>{if(x.value!=="all")x.checked=false;});
    } else {
      document.querySelector('.countryChk[value="all"]').checked=false;
    }
    updateCountryButtonLabel();
  }
  updateLayers();
});

document.getElementById("countryDropdownBtn").addEventListener("click",()=>{
  const m=document.getElementById("countryDropdownMenu");
  m.style.display = m.style.display==="block" ? "none" : "block";
});

document.addEventListener("click",e=>{
  if(!document.getElementById("countryDropdown").contains(e.target)){
    document.getElementById("countryDropdownMenu").style.display="none";
  }
});

/* Suche */
document.getElementById("searchInput").addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    const q=e.target.value.toLowerCase();
    const hit=alleMarker.find(m=>m.marker.getTooltip()?.getContent().toLowerCase().includes(q));
    if(hit){
      map.setView(hit.marker.getLatLng(),10);
      hit.marker.openTooltip();
    } else alert("Kein Treffer");
  }
});

/* Start */
(async()=>{
  await ladeDaten();
  await buildMap();
})();
</script>

</body>
</html>
