<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pelletwerke ‚Äì Europa Preiskarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100%}

    /* ============================
       Boxen allgemein
    ============================ */
    .legend, .cert-box {
      position:absolute;
      background:#fff;
      padding:8px 10px;
      border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.12);
      font:14px/1.3 system-ui,Arial,sans-serif;
    }

    /* Zertifikate-Box tiefer */
    .cert-box{
      bottom:12px;
      left:12px;
      z-index:1000;
    }

    /* Legende h√∂her & √ºber allem */
    .legend{
      bottom:80px;
      right:12px;
      min-width:180px;
      z-index:2000; /* WICHTIG */
    }

    .cert-box input[type="checkbox"],
    .legend input[type="checkbox"]{
      width:14px;height:14px;margin-right:5px;vertical-align:middle;
    }

    /* ============================
       Suchfeld
    ============================ */
    .search-box{
      position:absolute;top:12px;right:12px;z-index:1500;
      background:#fff;padding:8px 10px;border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      font:14px system-ui,Arial,sans-serif
    }
    .search-box input{
      width:220px;padding:6px 8px;border:1px solid #ccc;border-radius:4px;outline:none;
    }
    .cert-box hr{border:none;height:1px;background:#eee;margin:6px 0}

    /* ============================
       Dropdown L√§nder
    ============================ */
    .country-dropdown {
      position: relative;
      display: inline-block;
      width: 100%;
    }
    .country-dropdown-button {
      width: 100%;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px 6px;
      text-align: left;
      cursor: pointer;
    }
    .country-dropdown-button:after {
      content: "‚ñæ";
      float: right;
      opacity: .6;
    }
    .country-dropdown-menu {
      position: absolute;
      top: 110%;
      left: 0;
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-shadow: 0 2px 8px rgba(0,0,0,.12);
      display: none;
      min-width: 160px;
      max-height: 260px;   /* h√∂her als vorher */
      overflow-y: auto;
      padding: 6px 8px;

      z-index:3000; /* WICHTIG ‚Äì ganz oben */
    }
    .country-dropdown-menu label {
      display: block;
      cursor: pointer;
      margin-bottom: 3px;
    }
  </style>
</head>
<body>

<div id="map"></div>

<!-- Suche -->
<div class="search-box">
  üîç <input type="text" id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶" />
</div>

<!-- Zertifikate + Sackware -->
<div class="cert-box">
  <b>Zertifikate & Sackware</b><br>
  <label><input type="checkbox" id="chkEnPlus" checked> EnPlus</label><br>
  <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
  <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
  <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>
  <hr>
  <b>Sackware</b><br>
  <label><input type="checkbox" id="chkSackFireflies"> FireFlies</label><br>
  <label><input type="checkbox" id="chkSack15kg"> 15 kg</label>
</div>

<!-- L√§nder + Farben -->
<div class="legend">
  <b>Land / L√§nder filtern</b><br>

  <div class="country-dropdown" id="countryDropdown">
    <div class="country-dropdown-button" id="countryDropdownBtn">Alle L√§nder</div>
    <div class="country-dropdown-menu" id="countryDropdownMenu">
      <label><input type="checkbox" class="countryChk" value="all" checked> Alle</label>
      <label><input type="checkbox" class="countryChk" value="de"> Deutschland</label>
      <label><input type="checkbox" class="countryChk" value="at"> √ñsterreich</label>
      <label><input type="checkbox" class="countryChk" value="pl"> Polen</label>
      <label><input type="checkbox" class="countryChk" value="cz"> Tschechien</label>
      <label><input type="checkbox" class="countryChk" value="fr"> Frankreich</label>
      <label><input type="checkbox" class="countryChk" value="ch"> Schweiz</label>
      <label><input type="checkbox" class="countryChk" value="be"> Belgien</label>
      <label><input type="checkbox" class="countryChk" value="sk"> Slowakei</label>
    </div>
  </div>

  <br><br>

  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>
  <label><input type="checkbox" id="chkKunden" checked> üî∑ Kunden</label><br>
  <label><input type="checkbox" id="chkSackKunden" checked> üü£ Sackwaren-Kunden</label>
</div>


<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>

/* ============================================================
   MAP GRUNDSETUP
============================================================ */
const map = L.map("map").setView([51, 11], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  minZoom: 4, maxZoom: 10, attribution: "&copy; OpenStreetMap"
}).addTo(map);

function colorForPrice(p, keinPreis) {
  if (keinPreis) return "#9e9e9e";
  if (!p || p <= 0 || isNaN(p)) return "#9e9e9e";
  if (p <= 260) return "green";
  if (p < 285) return "orange";
  return "red";
}

/* ============================================================
   GEOCODING CACHE
============================================================ */
const geoCache = JSON.parse(localStorage.getItem("geoCachePellets_EU") || "{}");

async function geocode(q) {
  if (geoCache[q] && geoCache[q].country_code) return geoCache[q];

  const r = await fetch(
    `https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=${encodeURIComponent(q)}&limit=1&accept-language=de`
  );
  const d = await r.json();

  if (!d.length) return null;

  const m = {
    lat: +d[0].lat,
    lon: +d[0].lon,
    country_code: d[0].address.country_code.toLowerCase()
  };
  geoCache[q] = m;
  localStorage.setItem("geoCachePellets_EU", JSON.stringify(geoCache));
  return m;
}

/* ============================================================
   ICONS
============================================================ */
const blauesDreieck = L.divIcon({
  className:"cTriangle",
  html:`<svg width="24" height="24"><polygon points="12,2 22,22 2,22" fill="blue" stroke="black"/></svg>`,
  iconAnchor:[12,22]
});
const lilaDreieck = L.divIcon({
  className:"pTriangle",
  html:`<svg width="24" height="24"><polygon points="12,2 22,22 2,22" fill="purple" stroke="black"/></svg>`,
  iconAnchor:[12,22]
});

/* ============================================================
   GOOGLE SHEETS
============================================================ */
const sheetUrlFirmen = "https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/export?format=csv";
const sheetUrlKunden = "https://docs.google.com/spreadsheets/d/1DaiLyZbhJkdSQ1PHbJQmguIrDnGrrhiAVgJC4PJO8vA/export?format=csv&gid=0";

let werke=[], kunden=[], alleMarker=[], selectedPoints=[], routeLine=null;

/* ============================================================
   DATEN LADEN
============================================================ */
function parseFirmenWithHeader(rows){
  const keys = Object.keys(rows[0]);
  return rows.map(x=>({
    firma: x[keys[0]],
    ort:   x[keys[1]],
    preis: parseFloat((x[keys[2]]||"0").replace(",",".")),
    preisSack: parseFloat((x[keys[4]]||"0").replace(",",".")),
    zert:  (x[keys[6]]||"").toLowerCase(),
    sack:  (x[keys[7]]||"")
  }));
}

async function ladeDaten(){
  // Werke
  werke = await new Promise(resolve=>{
    Papa.parse(sheetUrlFirmen,{download:true,header:true,complete:r=>{
      resolve(parseFirmenWithHeader(r.data));
    }});
  });

  // Kunden
  kunden = await new Promise(resolve=>{
    Papa.parse(sheetUrlKunden,{download:true,header:true,complete:r=>{
      resolve(r.data);
    }});
  });
}

/* ============================================================
   KARTENAUFBAU
============================================================ */
async function buildMap(){
  alleMarker=[];
  const bounds=L.latLngBounds();

  // Werke
  for(const w of werke){
    const c = await geocode(w.ort);
    if(!c) continue;

    const farbe = colorForPrice(w.preis,false);
    const mk = L.circleMarker([c.lat,c.lon],{
      radius:8, color:farbe, fillColor:farbe, fillOpacity:0.85
    })
    .bindTooltip(`<b>${w.firma}</b><br>${w.ort}`)
    .on("click",()=>handleMarkerClick(w.firma,c));

    alleMarker.push({type:"firma", marker:mk, country_code:c.country_code});
    bounds.extend([c.lat,c.lon]);
  }

  // Kunden
  for(const k of kunden){
    const c = await geocode(k.ort);
    if(!c) continue;

    const icon = (k.sackware==="ja" && k.lose!=="ja") ? lilaDreieck : blauesDreieck;
    const mk = L.marker([c.lat,c.lon],{icon})
      .bindTooltip(`<b>${k.name}</b><br>${k.ort}`)
      .on("click",()=>handleMarkerClick(k.name,c));

    alleMarker.push({type:"kunde", marker:mk, country_code:c.country_code});
    bounds.extend([c.lat,c.lon]);
  }

  map.fitBounds(bounds.pad(0.2));
  updateLayers();
}

/* ============================================================
   FILTER
============================================================ */
function getSelectedCountries(){
  const sel=[...document.querySelectorAll(".countryChk:checked")].map(x=>x.value);
  return sel.includes("all") ? ["all"] : sel;
}

function updateCountryButtonLabel(){
  const sel=getSelectedCountries();
  const btn=document.getElementById("countryDropdownBtn");
  if(sel[0]==="all"){btn.textContent="Alle L√§nder";return;}

  const short={de:"DE",at:"AT",pl:"PL",cz:"CZ",fr:"FR",ch:"CH",be:"BE",sk:"SK"};
  btn.textContent=sel.map(c=>short[c]||c).join(", ");
}

function updateLayers(){
  alleMarker.forEach(m=>map.removeLayer(m.marker));

  const sel=getSelectedCountries();
  const noFilter=sel[0]==="all";

  alleMarker.forEach(m=>{
    if(noFilter || sel.includes(m.country_code)){
      map.addLayer(m.marker);
    }
  });
}

/* ============================================================
   ROUTENANZEIGE
============================================================ */
function handleMarkerClick(label,coord){
  selectedPoints.push({label,coord});
  if(selectedPoints.length===2){
    const [a,b]=selectedPoints;
    showRoute(a,b);
    selectedPoints=[];
  }
}

async function showRoute(a,b){
  const url=`https://router.project-osrm.org/route/v1/driving/${a.coord.lon},${a.coord.lat};${b.coord.lon},${b.coord.lat}?overview=full&geometries=geojson`;
  const r=await fetch(url);
  const d=await r.json();
  if(!d.routes.length) return;

  const coords=d.routes[0].geometry.coordinates.map(c=>[c[1],c[0]]);

  if(routeLine) map.removeLayer(routeLine);
  routeLine=L.polyline(coords,{color:"blue",weight:5}).addTo(map);

  map.fitBounds(routeLine.getBounds(),{padding:[40,40]});
}

/* ============================================================
   ROUTE ENTFERNEN BEIM KLICK AUF KARTE
============================================================ */
map.on("click",e=>{
  const t=e.originalEvent.target;
  if(t.closest && (
      t.closest('.leaflet-marker-icon') ||
      t.closest('.leaflet-popup') ||
      t.closest('.leaflet-interactive')))
      return;

  if(routeLine){ map.removeLayer(routeLine); routeLine=null; }
  map.closePopup();
});

/* ============================================================
   UI EVENTS
============================================================ */
document.addEventListener("change",e=>{
  if(e.target.classList.contains("countryChk")){
    if(e.target.value==="all"){
      if(e.target.checked){
        document.querySelectorAll(".countryChk").forEach(c=>{if(c.value!=="all")c.checked=false;});
      }
    } else {
      document.querySelector('.countryChk[value="all"]').checked=false;
    }
    updateCountryButtonLabel();
    updateLayers();
  }
});

document.getElementById("countryDropdownBtn").addEventListener("click",()=>{
  const m=document.getElementById("countryDropdownMenu");
  m.style.display=m.style.display==="block"?"none":"block";
});

document.addEventListener("click",e=>{
  const dd=document.getElementById("countryDropdown");
  if(!dd.contains(e.target)){
    document.getElementById("countryDropdownMenu").style.display="none";
  }
});

/* Suche */
document.getElementById("searchInput").addEventListener("keydown",e=>{
  if(e.key!=="Enter") return;
  const q=e.target.value.toLowerCase();
  const hit=alleMarker.find(m=>String(m.marker.getTooltip().getContent()).toLowerCase().includes(q));
  if(hit){
    map.setView(hit.marker.getLatLng(),9);
    hit.marker.openTooltip();
  }
});

/* ============================================================
   START
============================================================ */
(async ()=>{
  await ladeDaten();
  await buildMap();
})();
</script>

</body>
</html>
